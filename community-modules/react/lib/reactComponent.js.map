{"version":3,"sources":["reactComponent.ts"],"names":[],"mappings":"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","file":"reactComponent.js","sourcesContent":["import * as React from 'react';\nimport { ReactPortal } from 'react';\nimport * as ReactDOM from 'react-dom';\nimport { _, ComponentType, Promise } from '@ag-grid-community/core';\nimport { AgGridReact } from './agGridReact';\nimport { BaseReactComponent } from './baseReactComponent';\nimport { assignProperties } from './utils';\nimport generateNewKey from './keyGenerator';\nimport { renderToStaticMarkup } from 'react-dom/server';\n\nexport class ReactComponent extends BaseReactComponent {\n  static REACT_MEMO_TYPE = ReactComponent.hasSymbol()\n    ? Symbol.for('react.memo')\n    : 0xead3;\n\n  private eParentElement!: HTMLElement;\n  private componentInstance: any;\n\n  private reactComponent: any;\n  private componentType: ComponentType;\n  private parentComponent: AgGridReact;\n  private portal: ReactPortal | null = null;\n  private componentWrappingElement: string = 'div';\n  private statelessComponent: boolean;\n  private staticMarkup: HTMLElement | null | string = null;\n  private staticRenderTime: number = 0;\n\n  constructor(\n    reactComponent: any,\n    parentComponent: AgGridReact,\n    componentType: ComponentType,\n  ) {\n    super();\n\n    this.reactComponent = reactComponent;\n    this.componentType = componentType;\n    this.parentComponent = parentComponent;\n    this.statelessComponent = ReactComponent.isStateless(this.reactComponent);\n  }\n\n  public getFrameworkComponentInstance(): any {\n    return this.componentInstance;\n  }\n\n  public isStatelessComponent(): boolean {\n    return this.statelessComponent;\n  }\n\n  public getReactComponentName(): string {\n    return this.reactComponent.name;\n  }\n\n  public init(params: any): Promise<void> {\n    this.eParentElement = this.createParentElement(params);\n\n    this.renderStaticMarkup(params);\n\n    return new Promise<void>((resolve) =>\n      this.createReactComponent(params, resolve),\n    );\n  }\n\n  public getGui(): HTMLElement {\n    return this.eParentElement;\n  }\n\n  public destroy(): void {\n    return this.parentComponent.destroyPortal(this.portal as ReactPortal);\n  }\n\n  private createReactComponent(params: any, resolve: (value: any) => void) {\n    if (!this.statelessComponent) {\n      // grab hold of the actual instance created\n      params.ref = (element: any) => {\n        this.componentInstance = element;\n\n        this.addParentContainerStyleAndClasses();\n\n        // regular components (ie not functional)\n        this.removeStaticMarkup();\n      };\n    }\n\n    const reactComponent = React.createElement(this.reactComponent, params);\n    const portal: ReactPortal = ReactDOM.createPortal(\n      reactComponent,\n      this.eParentElement as any,\n      generateNewKey(), // fixed deltaRowModeRefreshCompRenderer\n    );\n    this.portal = portal;\n    this.parentComponent.mountReactPortal(portal!, this, (value: any) => {\n      resolve(value);\n\n      // functional/stateless components have a slightly different lifecycle (no refs) so we'll clean them up\n      // here\n      if (this.statelessComponent) {\n        // if a user supplies a time consuming renderer then it's sometimes possible both the static and\n        // actual react component are visible at the same time\n        // we check here if the rendering is \"slow\" (anything greater than 2ms) we'll use a listener to remove the\n        // static markup, otherwise just the next tick\n        if (this.staticRenderTime >= 2) {\n          this.eParentElement.addEventListener(\n            'DOMNodeInserted',\n            () => {\n              this.removeStaticMarkup();\n            },\n            false,\n          );\n        } else {\n          setTimeout(() => {\n            this.removeStaticMarkup();\n          });\n        }\n      }\n    });\n  }\n\n  private addParentContainerStyleAndClasses() {\n    if (!this.componentInstance) {\n      return;\n    }\n\n    if (\n      this.componentInstance.getReactContainerStyle &&\n      this.componentInstance.getReactContainerStyle()\n    ) {\n      assignProperties(\n        this.eParentElement.style,\n        this.componentInstance.getReactContainerStyle(),\n      );\n    }\n    if (\n      this.componentInstance.getReactContainerClasses &&\n      this.componentInstance.getReactContainerClasses()\n    ) {\n      const parentContainerClasses: string[] = this.componentInstance.getReactContainerClasses();\n      parentContainerClasses.forEach((className) =>\n        _.addCssClass(this.eParentElement as HTMLElement, className),\n      );\n    }\n  }\n\n  private createParentElement(params: any) {\n    const eParentElement = document.createElement(\n      this.parentComponent.props.componentWrappingElement || 'div',\n    );\n\n    _.addCssClass(eParentElement as HTMLElement, 'ag-react-container');\n\n    // DEPRECATED - use componentInstance.getReactContainerStyle or componentInstance.getReactContainerClasses instead\n    // so user can have access to the react container, to add css class or style\n    params.reactContainer = eParentElement;\n\n    return eParentElement;\n  }\n\n  public statelessComponentRendered(): boolean {\n    // fixed fragmentsFuncRendererCreateDestroy funcRendererWithNan (changeDetectionService too for NaN)\n    return (\n      this.eParentElement.childElementCount > 0 ||\n      this.eParentElement.childNodes.length > 0\n    );\n  }\n\n  private static hasSymbol() {\n    return typeof Symbol === 'function' && Symbol.for;\n  }\n\n  private static isStateless(Component: any) {\n    return (\n      (typeof Component === 'function' &&\n        !(Component.prototype && Component.prototype.isReactComponent)) ||\n      (typeof Component === 'object' &&\n        Component.$$typeof === ReactComponent.REACT_MEMO_TYPE)\n    );\n  }\n\n  public isNullRender(): boolean {\n    return this.staticMarkup === '';\n  }\n\n  /*\n   * Attempt to render the component as static markup if possible\n   * What this does is eliminate any visible flicker for the user in the scenario where a component is destroyed and\n   * recreated with exactly the same data (ie with force refresh)\n   * Note: Some use cases will throw an error (ie when using Context) so if an error occurs just ignore it any move on\n   */\n  private renderStaticMarkup(params: any) {\n    if (\n      this.parentComponent.isDisableStaticMarkup() ||\n      (this.componentType.isCellRenderer &&\n        !this.componentType.isCellRenderer())\n    ) {\n      return;\n    }\n\n    const originalConsoleError = console.error;\n    const reactComponent = React.createElement(this.reactComponent, params);\n    try {\n      // if a user is using anything that uses useLayoutEffect (like material ui) then\n      // Warning: useLayoutEffect does nothing on the s   erver will be throw and we can't do anything to stop it\n      // this is just a warning and has no effect on anything so just suppress it for this single operation\n      const originalConsoleError = console.error;\n      console.error = () => {};\n\n      const start = Date.now();\n      const staticMarkup = renderToStaticMarkup(reactComponent);\n      this.staticRenderTime = Date.now() - start;\n\n      console.error = originalConsoleError;\n\n      // if the render method returns null the result will be an empty string\n      if (staticMarkup === '') {\n        this.staticMarkup = staticMarkup;\n      } else {\n        if (staticMarkup) {\n          // we wrap the content as if there is \"trailing\" text etc it's not easy to safely remove\n          // the same is true for memoized renderers, renderers that that return simple strings or NaN etc\n          this.staticMarkup = document.createElement('span');\n          this.staticMarkup.innerHTML = staticMarkup;\n          this.eParentElement.appendChild(this.staticMarkup);\n        }\n      }\n    } catch (e) {\n      // we tried - this can happen with certain (rare) edge cases\n    } finally {\n      console.error = originalConsoleError;\n    }\n  }\n\n  private removeStaticMarkup() {\n    if (\n      this.parentComponent.isDisableStaticMarkup() ||\n      !this.componentType.isCellRenderer()\n    ) {\n      return;\n    }\n\n    if (this.staticMarkup) {\n      if ((this.staticMarkup as HTMLElement).remove) {\n        // everyone else in the world\n        (this.staticMarkup as HTMLElement).remove();\n        this.staticMarkup = null;\n      } else if (this.eParentElement.removeChild) {\n        // ie11...\n        this.eParentElement.removeChild(this.staticMarkup as any);\n        this.staticMarkup = null;\n      }\n    }\n  }\n\n  rendered() {\n    return (\n      this.isNullRender() ||\n      this.staticMarkup ||\n      (this.isStatelessComponent() && this.statelessComponentRendered()) ||\n      (!this.isStatelessComponent() && this.getFrameworkComponentInstance())\n    );\n  }\n}\n"]}